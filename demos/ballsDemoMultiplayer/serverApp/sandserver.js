(function(){var k=null;function l(){return function(){}}function m(a,b){function c(){}c.prototype=b.prototype;a.va=b.prototype;a.prototype=new c};var n;function q(a){if(a instanceof q)this.w=a.w.slice(0);else if(a instanceof Array&&2<a.length)this.w=a.slice(0);else if("string"==typeof a||"number"==typeof a)"string"==typeof a&&(a=parseInt("0x"+a.replace("#","").substring(0,6))),a&=16777215,this.w=[(a&16711680)>>16,(a&65280)>>8,a&255]};function r(a,b){this.b=a;this.d=b}r.prototype.length=function(){return Math.sqrt(this.b*this.b+this.d*this.d)};function s(){this.g=1;this.i=this.h=0;this.j=1;this.m=this.l=0;this.ta=Array(9)}function t(a,b,c,d,f,g,e){a.g=b;a.h=c;a.i=d;a.j=f;a.l=g;a.m=e}s.prototype.toString=function(){return"(a="+this.g+", b="+this.h+", c="+this.i+", d="+this.j+", tx="+this.l+", ty="+this.m+")"};function u(a,b){t(a,b.g*a.g+b.i*a.h,b.h*a.g+b.j*a.h,b.g*a.i+b.i*a.j,b.h*a.i+b.j*a.j,b.g*a.l+b.i*a.m+1*b.l,b.h*a.l+b.j*a.m+1*b.m)}s.prototype.translate=function(a,b){this.l+=a;this.m+=b;return this};
s.prototype.scale=function(a,b){this.g*=a;this.h*=b;this.i*=a;this.j*=b;this.l*=a;this.m*=b;return this};s.prototype.rotate=function(a){var b=new s;t(b,-Math.cos(a),-Math.sin(a),-Math.sin(a),Math.cos(a),0,0);u(this,b);delete b;return this};var w=0;function x(a,b,c,d,f,g){this.a=new r(a||0,b||0);this.R=d||0;this.F=this.D=0;this.T=c||1;this.U=c||1;this.q=k;this.ua=!1;this.O=this.N=0;this.K=f instanceof q?f:new q(f||16777215);this.ja=g||1;this.s=w++;this.ca=[]}x.prototype.n=1001;x.prototype.t=l();x.prototype.toJSON=function(){return"{"+this.f()+"}"};
x.prototype.f=function(){var a;a=""+('"cid":'+this.n+",");a+='"doid":'+this.s+",";a+='"x":'+Math.floor(1E3*this.a.b)/1E3+",";a+='"y":'+Math.floor(1E3*this.a.d)/1E3+",";a+='"r":'+Math.floor(100*this.R)/100+",";a+='"px":'+this.D+",";a+='"py":'+this.F+",";a+='"sx":'+this.T+",";a+='"sy":'+this.U+",";a+='"ox":'+this.N+",";a+='"oy":'+this.O+",";a+='"c":'+JSON.stringify(this.K.w)+",";a+='"a":'+this.ja;return a+=',"snds":'+JSON.stringify(this.ca)};function y(a,b,c,d,f){x.call(this,a,b,1,0,f,1);this.qa=c||10;this.ma=d||10}m(y,x);y.prototype.n=1003;y.prototype.toJSON=function(){return"{"+this.f()+"}"};y.prototype.f=function(){var a=x.prototype.f.call(this)+",",a=a+('"w": '+this.qa+",");return a+='"h": '+this.ma};function A(a,b,c,d){y.call(this,a,b,2*c,2*c,d);this.D=this.F=this.k=c}m(A,y);A.prototype.n=3001;A.createFromSerializedObject=function(a){var b=new A(a.x,a.y,a.rd,a.c);b.s=a.doid;return b};
A.prototype.t=function(a){for(var b=n.X.r,c=0;c<b.length;++c){var d=b[c].C,f=this.a,g;g=d.M;for(var e=[],h=this;h.q;)e.unshift(h.q),h=h.q;var h=new s,z=new s;for(matIndex in e){t(z,1,0,0,1,0,0);var j=e[matIndex],v=z,v=v||new s;(0!=j.D||0!=j.F)&&v.translate(-j.D,-j.F);(0!=j.N||0!=j.O)&&v.translate(-j.N,-j.O);(1!=j.T||1!=j.U)&&v.scale(j.T,j.U);0!=j.R&&v.rotate(j.R);(0!=j.a.b||0!=j.a.d)&&v.translate(j.a.b,j.a.d);u(h,z)}e=h;h=e.g*e.j-e.i*e.h;t(e,e.j/h,-e.h/h,-e.i/h,e.g/h,(e.i*e.m-e.j*e.l)/h,(e.h*e.l-
e.g*e.m)/h);h=void 0;h=new r(0,0);z=g.b;h.b=e.g*g.b+e.i*g.d+e.l;h.d=e.h*z+e.j*g.d+e.m;g=h;delete worldMatrix;f=new r(g.b-f.b,g.d-f.d);g=f.length();d=d.aa._16!=k?1:-1;this.a.b+=0.2*(Math.max(0,100-g)*f.b*a)*d;this.a.d+=0.2*(Math.max(0,100-g)*f.d*a)*d}this.a.b=Math.max(Math.min(this.a.b,B.J-this.k),this.k);this.a.d=Math.max(Math.min(this.a.d,B.I-this.k),this.k);b=this.q.e;for(c=b.indexOf(this);c<b.length;++c)d=b[c],d instanceof A&&(f=new r(d.a.b-this.a.b,d.a.d-this.a.d),g=f.length()+0.1,this.a.b+=-Math.max(0,
d.k+this.k-g)*f.b*a,this.a.d+=-Math.max(0,d.k+this.k-g)*f.d*a,d.a.b+=Math.max(0,d.k+this.k-g)*f.b*a,d.a.d+=Math.max(0,d.k+this.k-g)*f.d*a)};A.prototype.toJSON=function(){return"{"+this.f()+"}"};A.prototype.f=function(){var a='"cid":'+this.n+",",a=a+('"doid":'+this.s+","),a=a+('"x":'+Math.floor(1E3*this.a.b)/1E3+","),a=a+('"y":'+Math.floor(1E3*this.a.d)/1E3+","),a=a+('"rd":'+this.k+",");return a+='"c":'+JSON.stringify(this.K.w)};function C(a,b,c,d){x.call(this,a,b,c,d);this.e=[];this.G=[]}m(C,x);C.prototype.n=1002;C.prototype.t=function(a){D(this,a)};function D(a,b){for(var c in a.e)a.e[c].t&&a.e[c].t(b)}function E(a,b){if(b instanceof Array)for(var c in b)E(a,b[c]);else b instanceof x&&(b.q&&F(b.q,b),b.q=a,a.e.push(b))}function F(a,b){if(b instanceof Array)for(var c in b)F(a,b[c]);else c=a.e.indexOf(b),-1!=c&&(a.G.push(b.s),a.e.splice(c,1)),b.q=k}C.prototype.toJSON=function(){return"{"+this.f()+"}"};
C.prototype.f=function(a,b){var c="";b?(c+='"cid":'+this.n+",",c+='"doid":'+this.s+","):c+=x.prototype.f.call(this)+",";for(var c=c+'"clist":[',d=0;d<this.e.length;d++)c+=this.e[d].toJSON(),d+1<this.e.length&&(c+=",");c=c+"]"+(',"rmobjts":'+JSON.stringify(this.G));a||(delete this.G,this.G=[]);return c};function G(){C.call(this);this.$=k}m(G,C);G.prototype.n=1006;G.prototype.t=function(a){D(this,a);a=this.$.X;if(0<a.r.length){var b='["SCENE",'+this.toJSON()+"]",c;for(c in a.r)a.r[c].send(b)}};G.prototype.fa=l();G.prototype.ga=l();G.prototype.ea=l();G.prototype.f=function(){return C.prototype.f.call(this,!0,!0)};var B={ha:60,J:800,I:600,ia:"localhost",W:0,ha:60,J:768,I:432,ia:"niutek.net",W:51137};function H(a){y.call(this,0,0,5,5,16777215);this.B=a||k;this.v=""}m(H,y);H.prototype.n=3003;H.createFromSerializedObject=function(a){var b=new H;b.s=a.doid;return b};H.prototype.t=function(){this.a.b=this.B.C.z;this.a.d=this.B.C.A};H.prototype.toJSON=function(){return"{"+this.f()+"}"};H.prototype.f=function(){var a='"cid":'+this.n+",",a=a+('"doid":'+this.s+","),a=a+('"x":'+Math.floor(this.a.b)+","),a=a+('"y":'+Math.floor(this.a.d)+",");return a+='"uname":"'+this.v+'"'};function I(){G.call(this);for(var a=100;a--;){var b=new A(0.5*B.J+10*Math.random(),0.5*B.I+10*Math.random(),10,"#"+Math.floor(16777215*Math.max(Math.random(),0.2)).toString(16));E(this,b)}this.o=new C;E(this,this.o)}m(I,G);I.prototype.n=3002;I.prototype.fa=function(a){E(this.o,new H(a))};I.prototype.ga=function(a){for(var b=0;b<this.o.e.length;++b){var c=this.o.e[b];c.B==a&&(F(this.o,c),b=this.o.e.length,console.log(a.v+" disconnect"))}};
I.prototype.ea=function(a){for(var b=0;b<this.o.e.length;++b){var c=this.o.e[b];c.B==a&&(c.v=a.v,b=this.o.e.length)}};function J(){this.aa={};this.A=this.z=-50;this.Q=this.P=0;this.M=new r(this.z,this.A);this.ba=new r(this.P,this.Q);this.na=this.L=!1};function K(a,b){this.oa=30;this.pa=require("websocket").server;this.la=require("http");this.V=a;this.r=[];this.Y=this.la.createServer(l());var c={};c.httpServer=this.Y;this.da=new this.pa(c);this.da.p=this;this.da.on("request",function(a){console.log("a user log in");a=a.accept(k,a.origin);this.p.r.length>=this.p.oa?(console.log("user rejected"),a.send('["REJECTED","Too many players connected."]'),a.close()):(this.p.r.push(a),a.v="",a.H=this,a.C=new J,a.sa=L++,this.p.V.u.fa(a),a.on("message",function(a){var b=
JSON.parse(a.utf8Data);a=b[1];switch(b[0]){case "UINPUT":b=this.C;b.P=b.z;b.Q=b.A;b.ba.b=b.P;b.ba.d=b.Q;b.na=b.L;b.L=b.ra;b.aa=a.keys;b.z=a.mx;b.A=a.my;b.L=a.md;b.M.b=b.z;b.M.d=b.A;break;case "UNAME":this.v=a,this.H.p.V.u.ea(this)}}),a.on("close",function(){this.H.p.r.splice(this.H.p.r.indexOf(this),1);console.log("a user disconnect");this.H.p.V.u.ga(this)}))});this.Y.listen(b,l());console.log("Server comunication initialized")}var L=1E3;function M(){N(n)}function N(a){var b=(new Date).getTime();a.u.t((b-a.Z)/1E3);a.Z=b;b=1/a.ka-((new Date).getTime()-b)/1E3;a.S&&setTimeout(M,1E3*b)};var O=new function(){var a=new I,b=B.W;this.S=!1;this.ka=20;this.Z=(new Date).getTime();n=this;this.u=a;this.u.$=this;this.X=new K(this,b);this.ca=[]};!O.S&&O.u!=k&&(O.S=!0,N(O));})();
